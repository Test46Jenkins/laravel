name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch :

jobs:
  composer_development:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: Install Composer dependencies
      run: composer install
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    - name: Install npm dependencies
      run: npm install
    - name: zipping & Upload ZIP to S3
    - name: Prepare AWS CodeDeploy
      run: |
          sed -i '1 a codedeploy_application_name="${{ secrets.CODEDEPLOY_APPLICATION }}"' scripts/aws_codedeploy.sh
          sed -i '2 a codedeploy_groupname="${{ secrets.CODEDEPLOY_GROUPNAME }}"' scripts/aws_codedeploy.sh
          sed -i '3 a aws_s3_bucket_name="${{ secrets.AWS_S3_BUCKET }}"' scripts/aws_codedeploy.sh
          zip -r ${{ github.run_id }}.zip .  # Create a ZIP file of the application
          aws s3 cp ${{ github.run_id }}.zip s3://${{ secrets.AWS_S3_BUCKET }} --region us-east-2
    - name: AWS CodeDeploy
      run: |
          chmod +x scripts/*
          sh scripts/aws_codedeploy.sh
    env:
      CODEDEPLOY_APPLICATION_NAME: ${{ secrets.CODEDEPLOY_APPLICATION_NAME }}
      CODEDEPLOY_GROUP_NAME: ${{ secrets.CODEDEPLOY_GROUP_NAME }}
      AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
